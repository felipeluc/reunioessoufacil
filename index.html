<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reuniões — SouFácil</title>
  <style>
    :root{--accent:#007aff;--muted:#6b7280}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:#f3f6fb; margin:0; padding:24px; display:flex; justify-content:center}
    .app{width:1100px; max-width:96%; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:14px; box-shadow:0 10px 30px rgba(18,38,63,0.08); padding:20px;}
    header{display:flex; justify-content:space-between; align-items:center; margin-bottom:18px}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,#007aff,#4cc3ff); border-radius:12px;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .small{color:var(--muted);font-size:13px}
    .cols{display:grid; grid-template-columns:420px 1fr; gap:16px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,30,60,0.04)}
    label{display:block;font-size:13px;color:#333;margin-top:10px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;margin-top:6px;font-size:14px}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .actions { display:flex; gap:8px; margin-top:12px; }
    .btn-secondary { background:#eee; color:#111; }
    .meeting-card { padding:10px; border-radius:8px; border:1px solid #f1f3f6; margin-bottom:8px; background:#fff;}
    .meeting-meta { color:var(--muted); font-size:13px; margin-top:6px;}
    .details { margin-top:8px; background:#f8fbff; padding:10px; border-radius:8px; font-size:13px; display:none;}
    .detail-row { margin-bottom:6px;}
    .open-btn { background:#007aff; padding:6px 10px; border-radius:6px; color:#fff; cursor:pointer; border:none; }
    .no-meet { color:var(--muted); }
    pre.json { background:#f1f5f9; padding:8px; border-radius:6px; overflow:auto; font-size:12px;}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">SF</div>
        <div>
          <h1>Reuniões — SouFácil</h1>
          <div class="small">Autentique com Google para gravar no Sheets / Calendar</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center">
        <div id="userEmail" class="muted">Não conectado</div>
        <button id="btnSignIn">Entrar com Google</button>
        <button id="btnSignOut" class="btn-secondary" style="display:none">Sair</button>
      </div>
    </header>

    <div class="cols">
      <!-- Form -->
      <div class="card">
        <div><div class="small">Formulário de agendamento — Angela</div></div>

        <form id="formAgendamento" style="margin-top:12px">
          <label>Data do contato</label>
          <input type="date" name="data_contato" required>

          <label>Nome da empresa</label>
          <input type="text" name="empresa" required>

          <label>CNPJ</label>
          <input type="text" name="cnpj" placeholder="00.000.000/0000-00">

          <label>Quantidade de lojas</label>
          <input type="number" name="qtd_lojas" min="0">

          <label>Segmento</label>
          <select name="segmento" required>
            <option value="">Selecione</option>
            <option>Móveis</option><option>Óticas</option><option>Roupas</option><option>Calçados</option>
            <option>Celular</option><option>Mercado</option><option>Farmácia</option><option>Eletro</option>
            <option>Utilidades</option><option>Distribuidora</option><option>Clínica</option><option>Conveniência</option>
          </select>

          <label>UF</label>
          <select name="uf" required>
            <option value="">Selecione</option>
            <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option>
            <option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option>
            <option>MG</option><option>MS</option><option>MT</option><option>PA</option><option>PB</option>
            <option>PE</option><option>PI</option><option>PR</option><option>RJ</option><option>RN</option>
            <option>RO</option><option>RR</option><option>RS</option><option>SC</option><option>SE</option>
            <option>SP</option><option>TO</option>
          </select>

          <label>Prospecção</label>
          <select name="prospeccao" required>
            <option value="">Selecione</option>
            <option>Leads</option><option>Internet</option><option>Indicação</option><option>Ligação</option><option>Visita</option><option>Já é cliente</option>
          </select>

          <label>Nome</label>
          <input type="text" name="nome" required>

          <label>Função</label>
          <select name="funcao" required>
            <option value="">Selecione</option>
            <option>Funcionário</option><option>Vendedor</option><option>Proprietário</option><option>Gerente</option><option>Financeiro</option>
          </select>

          <label>Contato</label>
          <input type="tel" name="contato" placeholder="+55 (DDD) 90000-0000" required>

          <label>Reunião</label>
          <select name="reuniao" id="tipoReuniao" required>
            <option value="">Selecione</option>
            <option value="Ligação">Ligação</option>
            <option value="Whats">Whats</option>
            <option value="Meet">Meet</option>
          </select>

          <div class="row">
            <div>
              <label>Data da Reunião</label>
              <input type="date" name="data_reuniao" required>
            </div>
            <div>
              <label>Horário</label>
              <input type="time" name="horario" required>
            </div>
          </div>

          <label>Consultor</label>
          <select name="consultor" id="consultorSelect" required>
            <option value="">Selecione</option>
            <option value="5517992741145">Glaucia — +55 17 99274-1145</option>
            <option value="5517992021249">Leticia — +55 17 99202-1249</option>
            <option value="5517992724400">Marcelo — +55 17 99272-4400</option>
            <option value="5517992739551">Gabriel — +55 17 99273-9551</option>
          </select>

          <label>Observações</label>
          <textarea name="observacoes" rows="3" placeholder="Observações..."></textarea>

          <div class="actions">
            <button id="btnSalvar" type="button">Salvar (Planilha)</button>
            <button id="btnWhats" type="button">Enviar WhatsApp (Comprovante)</button>
            <button id="btnClear" type="button" class="btn-secondary">Limpar</button>
          </div>
        </form>
      </div>

      <!-- Right: painel simples -->
      <div>
        <div class="card">
          <div><div class="small">Painel</div><strong id="panelTitle">Visão</strong></div>
          <div style="margin-top:12px" id="panelsContent">
            <div class="small">Reuniões recentes</div>
            <div id="meetingsList" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="muted">Obs: substitua <code>Sheet1!A1:Z9999</code> se a sua aba/cabeçalho for diferente.</div>
  </div>

  <!-- libs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script>
  // CONFIG - insira sua API KEY abaixo (estes valores vinham no seu código enviado)
  const GOOGLE_CLIENT_ID = '689575420157-di4d81kgeo6tnaf70edsi6sii5523sev.apps.googleusercontent.com';
  const GOOGLE_API_KEY = 'AIzaSyAiU6bMImfPaQLJj8nVO4V0Je67sSyvGTo';
  const SHEET_ID = '1-kcIEyUDiBWcGEUKxqotqlpyT-hIta5k3Cx1_mFEUIg';
  const SHEET_RANGE = 'Sheet1!A1:Z9999';

  // DOM
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const userEmailEl = document.getElementById('userEmail');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnWhats = document.getElementById('btnWhats');
  const btnClear = document.getElementById('btnClear');
  const meetingsListEl = document.getElementById('meetingsList');

  // state
  let tokenClient;
  let gapiInited = false;
  let userProfile = null;

  // init gapi when loaded
  function initGapiClient(){
    gapi.load('client', async () => {
      try {
        await gapi.client.init({
          apiKey: GOOGLE_API_KEY,
          discoveryDocs: [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
          ]
        });
        gapiInited = true;
        console.log('gapi initialized');
        loadMeetings().catch(()=>{/*ignore*/});
      } catch (err) {
        console.error('gapi init error', err);
      }
    });
  }

  // init token client
  function initTokenClient(){
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar.events openid email profile',
      callback: (resp) => {
        if (resp.error) {
          console.error('token error', resp);
          alert('Erro ao autenticar: ' + resp.error);
          return;
        }
        fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: 'Bearer ' + resp.access_token }})
          .then(r=>r.json()).then(profile => {
            userProfile = profile;
            afterSignIn();
            loadMeetings().catch(()=>{/*ignore*/});
          }).catch(e => console.error(e));
      }
    });
  }

  btnSignIn.addEventListener('click', () => {
    if (!tokenClient) initTokenClient();
    tokenClient.requestAccessToken({prompt:'consent'});
  });
  btnSignOut.addEventListener('click', () => {
    userProfile = null;
    userEmailEl.textContent = 'Não conectado';
    btnSignOut.style.display = 'none';
    btnSignIn.style.display = 'inline-block';
  });

  function afterSignIn(){
    if(!userProfile) return;
    userEmailEl.textContent = userProfile.email;
    btnSignOut.style.display = 'inline-block';
    btnSignIn.style.display = 'none';
  }

  // collect form values into object
  function coletarDadosFormulario(){
    const f = document.getElementById('formAgendamento');
    const fd = new FormData(f);
    return {
      data_contato: fd.get('data_contato') || '',
      empresa: fd.get('empresa') || '',
      cnpj: fd.get('cnpj') || '',
      qtd_lojas: fd.get('qtd_lojas') || '',
      segmento: fd.get('segmento') || '',
      uf: fd.get('uf') || '',
      prospeccao: fd.get('prospeccao') || '',
      nome: fd.get('nome') || '',
      funcao: fd.get('funcao') || '',
      contato: fd.get('contato') || '',
      reuniao_tipo: fd.get('reuniao') || '',
      data_reuniao: fd.get('data_reuniao') || '',
      horario: fd.get('horario') || '',
      consultor_number: fd.get('consultor') || '',
      observacoes: fd.get('observacoes') || '',
      agendado_por: userProfile ? userProfile.email : 'anon',
      created_at: new Date().toISOString()
    };
  }

  // append to sheet (requires gapi initialized)
  async function salvarNaPlanilha(d){
    if(!gapiInited) throw new Error('APIs não inicializadas');
    const row = [
      d.created_at,
      d.data_contato,
      d.empresa,
      d.cnpj,
      d.qtd_lojas,
      d.segmento,
      d.uf,
      d.prospeccao,
      d.nome,
      d.funcao,
      d.contato,
      d.reuniao_tipo,
      d.data_reuniao,
      d.horario,
      consultorNumberToName(d.consultor_number),
      d.consultor_number,
      '', // meet link placeholder
      d.observacoes,
      d.agendado_por
    ];
    const params = { spreadsheetId: SHEET_ID, range: SHEET_RANGE, valueInputOption: 'RAW' };
    const body = { values: [ row ] };
    const resp = await gapi.client.sheets.spreadsheets.values.append(params, body);
    return resp;
  }

  // send whatsapp: opens wa.me link with encoded message (no emojis)
  function enviarWhatsapp(d, meetLink=''){
    const name = consultorNumberToName(d.consultor_number);
    let mensagem = 'Novo agendamento de reunião\n';
    mensagem += `Empresa: ${d.empresa}\n`;
    mensagem += `Data: ${d.data_reuniao} às ${d.horario}\n`;
    mensagem += `Contato: ${d.nome} (${d.funcao})\n`;
    mensagem += `Telefone: ${d.contato}\n`;
    mensagem += `Tipo: ${d.reuniao_tipo}\n`;
    if(meetLink) mensagem += `Link Meet: ${meetLink}\n`;
    mensagem += `Segmento: ${d.segmento} — UF: ${d.uf}\n`;
    mensagem += `Observações: ${d.observacoes || '-'}\n\n`;
    mensagem += `Enviado por: ${d.agendado_por}`;

    const numero = d.consultor_number.replace(/\D/g,'');
    const waUrl = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
    window.open(waUrl, '_blank');
  }

  // helper map
  function consultorNumberToName(num){
    const map = {
      '5517992741145':'Glaucia',
      '5517992021249':'Leticia',
      '5517992724400':'Marcelo',
      '5517992739551':'Gabriel'
    };
    return map[num] || num;
  }

  // Handlers for the two buttons
  btnSalvar.addEventListener('click', async () => {
    if(!userProfile){ alert('Faça login com Google antes de salvar.'); return; }
    const dados = coletarDadosFormulario();
    try {
      await salvarNaPlanilha(dados);
      alert('Salvo na planilha com sucesso.');
      loadMeetings().catch(()=>{/*ignore*/});
    } catch (err) {
      console.error(err);
      alert('Erro ao salvar — veja console.');
    }
  });

  btnWhats.addEventListener('click', async () => {
    const dados = coletarDadosFormulario();
    enviarWhatsapp(dados, '');
  });

  btnClear.addEventListener('click', () => document.getElementById('formAgendamento').reset());

  // Normaliza nomes de cabeçalho da planilha para chaves consistentes
  function normalizeHeader(h){
    if(!h) return '';
    return String(h).trim().toLowerCase().replace(/\s+/g,'_').replace(/[^a-z0-9_]/g,'');
  }

  // Tenta transformar várias representações de data em YYYY-MM-DD
  function toISODate(v){
    if(!v) return '';
    v = String(v).trim();
    // Já no formato ISO
    let m = v.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if(m) return `${m[1]}-${m[2]}-${m[3]}`;
    // dd/mm/yyyy ou dd-mm-yyyy
    m = v.match(/^(\d{2})[\/\-](\d{2})[\/\-](\d{4})$/);
    if(m) return `${m[3]}-${m[2]}-${m[1]}`;
    // tenta Date
    const d = new Date(v);
    if(!isNaN(d)) return d.toISOString().split('T')[0];
    return '';
  }

  function timeToMinutes(t){
    if(!t) return 24*60;
    const s = String(t).trim();
    const m = s.match(/(\d{1,2}):(\d{2})/);
    if(m) return parseInt(m[1],10)*60 + parseInt(m[2],10);
    // se for HHMM (ex: 0900)
    const mm = s.match(/^(\d{3,4})$/);
    if(mm){
      const str = mm[1];
      const h = str.length === 3 ? parseInt(str[0],10) : parseInt(str.slice(0,2),10);
      const min = str.length === 3 ? parseInt(str.slice(1),10) : parseInt(str.slice(2),10);
      return h*60 + min;
    }
    return 24*60;
  }

  function prettifyKey(k){
    if(!k) return '';
    return String(k).replace(/_/g,' ').split(' ').map(s => s.charAt(0).toUpperCase() + s.slice(1)).join(' ');
  }

  // Load meetings (read sheet) to show only today's, sorted by time
  async function loadMeetings(){
    if(!gapiInited) return;
    try {
      meetingsListEl.innerHTML = '<div class="no-meet">Carregando reuniões...</div>';
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: SHEET_RANGE });
      const rows = res.result.values || [];
      if(rows.length < 2){
        meetingsListEl.innerHTML = '<div class="muted">Nenhuma reunião registrada</div>';
        return;
      }

      const header = rows[0].map(h => h || '');
      const normalizedHeader = header.map(normalizeHeader);

      const data = rows.slice(1).map(r => {
        const obj = {};
        normalizedHeader.forEach((key,i) => { obj[key] = r[i] || ''; });
        return obj;
      });

      // data de hoje em ISO
      const hoje = new Date().toISOString().split('T')[0];

      // campos possíveis que armazenem a data no seu sheet
      const dateKeysCandidates = ['data_reuniao','datareuniao','data','data_da_reuniao','datadareuniao'];

      const meetingsHoje = data.filter(row => {
        const dateVal = dateKeysCandidates.map(k => row[k]).find(Boolean);
        const iso = toISODate(dateVal || '');
        return iso === hoje;
      });

      // ordenar por horário (tenta chaves diferentes)
      meetingsHoje.sort((a,b) => {
        const tA = a.horario || a.hora || a['horario_reuniao'] || '';
        const tB = b.horario || b.hora || b['horario_reuniao'] || '';
        return timeToMinutes(tA) - timeToMinutes(tB);
      });

      meetingsListEl.innerHTML = '';
      if(meetingsHoje.length === 0){
        meetingsListEl.innerHTML = '<div class="muted">Nenhuma reunião para hoje</div>';
        return;
      }

      meetingsHoje.forEach((r, idx) => {
        const id = 'meet-' + idx + '-' + Math.random().toString(36).slice(2,8);
        const company = r.empresa || r.nome_da_empresa || r['nome'] || r.company || '-';
        const horario = r.horario || r.hora || '-';
        // tenta pegar data para exibição e formata dd/mm/yyyy
        const rawDate = dateKeysCandidates.map(k => r[k]).find(Boolean) || '';
        const isoDate = toISODate(rawDate);
        const displayDate = isoDate ? isoDate.split('-').reverse().join('/') : (rawDate || '-');
        // tenta pegar consultor (nome ou número)
        const consultor = r.consultor || r.consultor_nome || r.consultor_name || consultorNumberToName(r.consultor_number || r.consultor || '');

        const card = document.createElement('div');
        card.className = 'meeting-card';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <strong>${escapeHtml(company)}</strong>
              <div class="meeting-meta">${escapeHtml(horario)} — ${escapeHtml(displayDate)} — ${escapeHtml(consultor)}</div>
            </div>
            <div>
              <button class="open-btn" data-target="${id}">Abrir informações</button>
            </div>
          </div>
          <div id="${id}" class="details" aria-hidden="true"></div>
        `;

        meetingsListEl.appendChild(card);

        const detailsEl = card.querySelector('#' + id);

        // preenche detalhes (exibe todas as chaves não vazias)
        const keys = Object.keys(r);
        let html = '';
        keys.forEach(k => {
          const v = r[k];
          if(v === undefined || v === null || String(v).trim() === '') return;
          let valueToShow = v;
          // se for número do consultor, mostra nome também
          if(k.includes('consultor') && /^\d{10,}$/.test(String(v).replace(/\D/g,''))){
            const name = consultorNumberToName(String(v).replace(/\D/g,''));
            valueToShow = `${v} (${name})`;
          }
          html += `<div class="detail-row"><strong>${escapeHtml(prettifyKey(k))}:</strong> ${escapeHtml(String(valueToShow))}</div>`;
        });

        if(!html) html = '<div class="muted">Nenhuma informação adicional</div>';

        detailsEl.innerHTML = html;

        // toggle
        const btn = card.querySelector('.open-btn');
        btn.addEventListener('click', () => {
          const showing = detailsEl.style.display !== 'none' && detailsEl.style.display !== '';
          detailsEl.style.display = showing ? 'none' : 'block';
          detailsEl.setAttribute('aria-hidden', showing ? 'true' : 'false');
          btn.textContent = showing ? 'Abrir informações' : 'Fechar informações';
        });
      });

    } catch (err) {
      console.error('loadMeetings error', err);
      meetingsListEl.innerHTML = '<div class="muted">Erro ao carregar reuniões (ver console)</div>';
    }
  }

  // small helper to escape HTML to avoid injeção na visualização
  function escapeHtml(str){
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // init on load
  window.onload = () => {
    const waitGapi = setInterval(() => {
      if(window.gapi && window.google){
        clearInterval(waitGapi);
        initGapiClient();
        initTokenClient();
      }
    }, 300);
  };
  </script>
</body>
</html>
