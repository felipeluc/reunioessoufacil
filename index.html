<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painel de Reuniões</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    body { font-family: 'Inter', sans-serif; margin:0; padding:0; background:#f7f7f7; }
    .hidden { display:none; }
    #painelReunioes { padding:20px; }
    .meeting { border:1px solid #ccc; padding:10px; margin-bottom:10px; border-radius:8px; background:#fff; }
    label { display:block; margin-top:10px; }
    input, select, textarea, button { padding:5px; margin-top:5px; width:100%; box-sizing:border-box; }
    button { cursor:pointer; margin-top:10px; }
    #formAngela { margin-bottom:20px; background:#fff; padding:15px; border-radius:8px; }
    #modalEdit { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); display:flex; align-items:center; justify-content:center; }
    #modalEditContent { background:#fff; padding:20px; border-radius:8px; width:400px; }
  </style>
</head>
<body>

<h1 id="painelTitulo">Carregando...</h1>

<!-- Seleção de tela (apenas admin) -->
<select id="selectUser" class="hidden"></select>

<!-- Formulário Angela -->
<form id="formAngela" class="hidden">
  <label>Data do Contato: <input type="date" name="data_contato" required></label>
  <label>Empresa: <input type="text" name="empresa" required></label>
  <label>Segmento: <input type="text" name="segmento" required></label>
  <label>UF: <input type="text" name="uf" required></label>
  <label>Prospecção: <input type="text" name="prospeccao" required></label>
  <label>Nome: <input type="text" name="nome" required></label>
  <label>Função: <input type="text" name="funcao" required></label>
  <label>Contato: <input type="text" name="contato" required></label>
  <label>Reunião: <input type="text" name="reuniao" required></label>
  <label>Data da Reunião: <input type="date" name="data_reuniao" required></label>
  <label>Horário: <input type="time" name="horario" required></label>
  <label>Consultor: <input type="text" name="consultor" required></label>
  <label>Observações: <textarea name="observacoes"></textarea></label>
  <button type="button" id="btnSalvar">Salvar</button>
  <button type="button" id="btnClear">Limpar</button>
  <button type="button" id="btnWhats">Enviar WhatsApp</button>
</form>

<!-- Filtro por data -->
<div>
  <label>Data inicial: <input type="date" id="filterStartDate"></label>
  <label>Data final: <input type="date" id="filterEndDate"></label>
  <button id="btnApplyDateFilter">Aplicar filtro</button>
  <button id="btnClearDate">Limpar filtro</button>
</div>

<!-- Lista de reuniões -->
<div id="listaReunioes"></div>

<div id="errorMsg" class="hidden" style="color:red;margin-top:10px;"></div>

<!-- Modal de edição -->
<div id="modalEdit" class="hidden">
  <div id="modalEditContent">
    <h3>Editar Reunião</h3>
    <label>Status: <input type="text" id="editStatus"></label>
    <label>Data da Reunião: <input type="date" id="editData"></label>
    <label>Horário: <input type="time" id="editHorario"></label>
    <label>Observações: <textarea id="editObs"></textarea></label>
    <button id="btnSaveEdit">Salvar</button>
    <button id="btnCloseModal">Fechar</button>
  </div>
</div>

<script>
const SHEET_ID = 'SEU_SHEET_ID_AQUI'; // coloque seu ID real
let allMeetingsData = [];
let currentView = null;
let currentConsultorName = null;
let rowBeingEdited = null;

const userProfile = { email: 'felipesoufacil@gmail.com' };
const emailAngela = 'angela@soufaciil.com';
const emailAdmin = 'admin@soufaciil.com';
const emailsConsultores = { 'lucas@soufaciil.com':'Lucas', 'joao@soufaciil.com':'João' };

const formAngela = document.getElementById('formAngela');
const painelReunioes = document.getElementById('listaReunioes');
const painelTitulo = document.getElementById('painelTitulo');
const selectUser = document.getElementById('selectUser');
const filterStartDate = document.getElementById('filterStartDate');
const filterEndDate = document.getElementById('filterEndDate');
const btnApplyDateFilter = document.getElementById('btnApplyDateFilter');
const btnClearDate = document.getElementById('btnClearDate');
const errorMsg = document.getElementById('errorMsg');

const btnSalvar = document.getElementById('btnSalvar');
const btnClear = document.getElementById('btnClear');
const btnWhats = document.getElementById('btnWhats');

const modalEdit = document.getElementById('modalEdit');
const editStatus = document.getElementById('editStatus');
const editData = document.getElementById('editData');
const editHorario = document.getElementById('editHorario');
const editObs = document.getElementById('editObs');
const btnSaveEdit = document.getElementById('btnSaveEdit');
const btnCloseModal = document.getElementById('btnCloseModal');

function showError(msg){ errorMsg.textContent = msg; errorMsg.classList.remove('hidden'); }
function hideError(){ errorMsg.textContent=''; errorMsg.classList.add('hidden'); }

async function loadMeetings(){
  try {
    const response = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range:'Sheet1!A2:Z'
    });
    const values = response.result.values || [];
    const headerResponse = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range:'Sheet1!A1:Z1'
    });
    const header = headerResponse.result.values[0];
    allMeetingsData = values.map(row=>{
      const obj={};
      header.forEach((h,i)=> obj[h]=row[i]||'');
      return obj;
    });
  } catch(err){ console.error('Erro ao carregar reuniões',err); }
}

function renderMeetings({view, consultor=null, startDate='', endDate=''}){
  painelReunioes.innerHTML='';
  let data = allMeetingsData;

  if(view==='consultor' && consultor) data = data.filter(r => r.consultor === consultor);
  if(startDate) data = data.filter(r => r.data_da_reuniao >= startDate);
  if(endDate) data = data.filter(r => r.data_da_reuniao <= endDate);

  if(data.length===0){ painelReunioes.innerHTML='<p>Nenhuma reunião encontrada</p>'; return; }

  data.forEach((r, idx)=>{
    const div=document.createElement('div');
    div.classList.add('meeting');
    div.innerHTML=`
      <strong>${r.empresa}</strong> (${r.segmento})<br/>
      Data da Reunião: ${r.data_da_reuniao} - ${r.horario}<br/>
      Consultor: ${r.consultor}<br/>
      Status: ${r.status}<br/>
      Observações: ${r.observacao || '-'}<br/>
      <button onclick="openEditModal(${idx})">Editar</button>
    `;
    painelReunioes.appendChild(div);
  });
}

function setupViewByEmail(){
  if(!userProfile?.email) return;
  const email = userProfile.email.toLowerCase();

  formAngela.classList.add('hidden');
  painelReunioes.classList.add('hidden');
  selectUser.classList.add('hidden');

  if(email===emailAngela){
    currentView='angela'; currentConsultorName=null;
    formAngela.classList.remove('hidden');
    painelReunioes.classList.remove('hidden');
    painelTitulo.textContent='Reuniões agendadas por Angela';
    populateFilterMonthOptions();
    renderMeetings({view:currentView});
  } else if(Object.keys(emailsConsultores).includes(email)){
    currentView='consultor'; currentConsultorName=emailsConsultores[email];
    painelReunioes.classList.remove('hidden');
    painelTitulo.textContent=`Reuniões de ${currentConsultorName}`;
    populateFilterMonthOptions();
    renderMeetings({view:currentView, consultor:currentConsultorName});
  } else if(email===emailAdmin){
    selectUser.classList.remove('hidden');
    selectUser.innerHTML = `<option value="">Selecione a tela</option><option value="angela">Angela</option>${Object.values(emailsConsultores).map(c=>`<option value="${c.toLowerCase()}">${c}</option>`).join('')}`;
    painelReunioes.classList.remove('hidden');
    painelTitulo.textContent='Selecione uma tela para visualizar';
    renderMeetings({view:null});
  } else{
    alert('Você não tem permissão para acessar este sistema.');
  }
}

selectUser.addEventListener('change', ()=>{
  const val=selectUser.value;
  if(val==='angela'){ currentView='angela'; currentConsultorName=null; formAngela.classList.remove('hidden'); painelTitulo.textContent='Reuniões agendadas por Angela'; renderMeetings({view:currentView}); }
  else if(val){ currentView='consultor'; currentConsultorName=val.charAt(0).toUpperCase()+val.slice(1); formAngela.classList.add('hidden'); painelTitulo.textContent=`Reuniões de ${currentConsultorName}`; renderMeetings({view:currentView, consultor:currentConsultorName}); }
  else{ formAngela.classList.add('hidden'); painelTitulo.textContent='Selecione uma tela para visualizar'; painelReunioes.innerHTML=''; currentView=null; currentConsultorName=null;}
});

btnApplyDateFilter.addEventListener('click', ()=>{
  renderMeetings({view:currentView, consultor:currentConsultorName, startDate:filterStartDate.value, endDate:filterEndDate.value});
});
btnClearDate.addEventListener('click', ()=>{
  filterStartDate.value=''; filterEndDate.value='';
  renderMeetings({view:currentView, consultor:currentConsultorName});
});

// === Formulário Angela ===
btnClear.addEventListener('click', ()=>formAngela.reset());

btnSalvar.addEventListener('click', async ()=>{
  const formData=new FormData(formAngela);
  const dataObj={};
  formData.forEach((v,k)=>dataObj[k]=v.trim());

  if(!dataObj.data_contato || !dataObj.empresa || !dataObj.segmento || !dataObj.uf || !dataObj.prospeccao || !dataObj.nome || !dataObj.funcao || !dataObj.contato || !dataObj.reuniao || !dataObj.data_reuniao || !dataObj.horario || !dataObj.consultor){
    alert('Preencha todos os campos obrigatórios!');
    return;
  }

  const novaLinha=[
    new Date().toLocaleDateString('pt-BR'),
    dataObj.data_contato,
    dataObj.empresa,
    dataObj.cnpj || '',
    dataObj.qtd_lojas || '',
    dataObj.segmento,
    dataObj.uf,
    dataObj.prospeccao,
    dataObj.nome,
    dataObj.funcao,
    dataObj.contato,
    dataObj.reuniao,
    dataObj.data_reuniao,
    dataObj.horario,
    dataObj.consultor,
    '',
    dataObj.observacoes || '',
    userProfile.email,
    'Agendada'
  ];

  try{
    await gapi.client.sheets.spreadsheets.values.append({
      spreadsheetId:SHEET_ID,
      range:'Sheet1!A1:Z1',
      valueInputOption:'RAW',
      insertDataOption:'INSERT_ROWS',
      resource:{values:[novaLinha]}
    });
    alert('Reunião agendada com sucesso!');
    formAngela.reset();
    await loadMeetings();
    renderMeetings({view:currentView, consultor:currentConsultorName});
  }catch(err){ console.error(err); alert('Erro ao salvar na planilha.'); }
});

btnWhats.addEventListener('click', ()=>{
  const formData=new FormData(formAngela);
  const empresa=formData.get('empresa');
  const consultor=formData.get('consultor');
  if(!empresa || !consultor){ alert('Preencha pelo menos empresa e consultor'); return; }
  const text=`Olá! Reunião agendada para a empresa *${empresa}* com o consultor *${consultor}*.`;
  const url=`https://wa.me/?text=${encodeURIComponent(text)}`;
  window.open(url,'_blank');
});

// === Modal edição ===
function openEditModal(idx){
  rowBeingEdited=idx;
  const r=allMeetingsData[idx];
  editStatus.value=r.status; editData.value=r.data_da_reuniao; editHorario.value=r.horario; editObs.value=r.observacao||'';
  modalEdit.classList.remove('hidden');
}

btnCloseModal.addEventListener('click', ()=> modalEdit.classList.add('hidden'));

btnSaveEdit.addEventListener('click', async ()=>{
  const r=allMeetingsData[rowBeingEdited];
  r.status=editStatus.value; r.data_da_reuniao=editData.value; r.horario=editHorario.value; r.observacao=editObs.value;

  const header=Object.keys(allMeetingsData[0]||{});
  const statusCol=header.indexOf('status');
  const dataReuniaoCol=header.indexOf('data_da_reuniao');
  const horarioCol=header.indexOf('horario');
  const observacaoCol=header.indexOf('observacao');
  if(statusCol===-1 || dataReuniaoCol===-1 || horarioCol===-1 || observacaoCol===-1){ alert('Colunas necessárias não encontradas na planilha.'); return; }

  let rowData=[];
  for(let h of header) rowData.push(allMeetingsData[rowBeingEdited][h]||'');

  rowData[statusCol]=r.status;
  rowData[dataReuniaoCol]=r.data_da_reuniao;
  rowData[horarioCol]=r.horario;
  rowData[observacaoCol]=r.observacao;

  try{
    await gapi.client.sheets.spreadsheets.values.update({
      spreadsheetId:SHEET_ID,
      range:`Sheet1!A${rowBeingEdited+2}:Z${rowBeingEdited+2}`,
      valueInputOption:'RAW',
      resource:{values:[rowData]}
    });
    alert('Reunião atualizada com sucesso!');
    modalEdit.classList.add('hidden');
    renderMeetings({view:currentView, consultor:currentConsultorName, startDate:filterStartDate.value, endDate:filterEndDate.value});
  }catch(err){ console.error(err); alert('Erro ao atualizar reunião.'); }
});

function populateFilterMonthOptions(){
  const monthsSet=new Set();
  allMeetingsData.forEach(r=>{
    if(r.data_da_reuniao && r.data_da_reuniao.length>=7) monthsSet.add(r.data_da_reuniao.slice(0,7));
  });
}

window.onload = ()=>{
  initTokenClient();
  initGapiClient();
  setupViewByEmail();
};
</script>
</body>
</html>
