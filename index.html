<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Controle de Reuniões - SouFacil</title>
<style>
  body { font-family: Arial, sans-serif; padding: 10px; background: #f9f9f9; }
  h1,h2,h3 { margin-bottom: 0.3em; }
  .hidden { display:none; }
  button { cursor:pointer; margin: 2px; }
  select, input, textarea { padding:5px; margin: 5px 0; width: 100%; max-width: 300px; }
  label { font-weight: bold; display: block; margin-top: 10px; }
  .meeting-item { border: 1px solid #ccc; background: #fff; margin-bottom: 10px; padding: 10px; border-radius: 6px; }
  .meeting-header { display: flex; justify-content: space-between; align-items: center; }
  .meeting-header strong { font-size: 1.1em; }
  .meeting-details { margin-top: 10px; display:none; }
  .muted { color: #777; font-size: 0.9em; }
  .actions button { margin-right: 5px; }
  #modalEdit { 
    position: fixed; top: 0; left: 0; right:0; bottom:0; background: rgba(0,0,0,0.6); 
    display:flex; align-items:center; justify-content:center; 
  }
  #modalEdit .content { background:#fff; padding:20px; border-radius:8px; width: 90%; max-width: 400px; }
  #modalEdit.hidden { display:none; }
  .cards-container { display: flex; gap: 15px; flex-wrap: wrap; margin-top: 15px; }
  .card { background: #fff; padding: 15px; border-radius: 6px; box-shadow: 0 0 5px #ccc; flex: 1 1 200px; }
  .filters { margin-top: 15px; margin-bottom: 15px; }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js"></script>
</head>
<body>

<h1>Controle de Reuniões - SouFacil</h1>

<div>
  <button id="btnSignIn">Login Google</button>
  <button id="btnSignOut" class="hidden">Logout</button>
  <span id="userEmail">Não conectado</span>
</div>

<hr/>

<!-- Select para Admin escolher tela -->
<div id="selectUserContainer" class="hidden">
  <label for="selectUser">Escolha a tela:</label>
  <select id="selectUser">
    <option value="">Selecione</option>
    <option value="angela">Angela (Agendamento)</option>
    <!-- Consultores dinâmicos via JS -->
  </select>
</div>

<!-- Tela Angela -->
<div id="formAngela" class="hidden">
  <h2>Formulário de Agendamento — Angela</h2>
  <form id="formAgendamento">
    <label>Data do contato*: <input type="date" name="data_contato" required></label>
    <label>Nome da empresa*: <input type="text" name="empresa" required></label>
    <label>CNPJ: <input type="text" name="cnpj"></label>
    <label>Quantidade de lojas: <input type="number" name="qtd_lojas" min="0"></label>
    <label>Segmento*: <input type="text" name="segmento" required></label>
    <label>UF*: <input type="text" name="uf" maxlength="2" required></label>
    <label>Prospecção*: <input type="text" name="prospeccao" required></label>
    <label>Nome do contato*: <input type="text" name="nome" required></label>
    <label>Função*: <input type="text" name="funcao" required></label>
    <label>Contato*: <input type="text" name="contato" required></label>
    <label>Tipo de reunião*: <input type="text" name="reuniao" required></label>
    <label>Data da reunião*: <input type="date" name="data_reuniao" required></label>
    <label>Horário*: <input type="time" name="horario" required></label>
    <label>Consultor*: 
      <select name="consultor" required id="selectConsultorForm">
        <!-- preenchido via JS -->
      </select>
    </label>
    <label>Observações: <textarea name="observacoes" rows="3"></textarea></label>
    <button type="button" id="btnSalvar">Salvar Agendamento</button>
    <button type="button" id="btnClear">Limpar</button>
  </form>
</div>

<!-- Painel geral de reuniões -->
<div id="painelReunioes" class="hidden">
  <h2 id="painelTitulo">Reuniões</h2>
  <div id="painelSubtitulo"></div>
  
  <div class="filters">
    <label for="filterDate">Filtrar por dia:</label>
    <input type="date" id="filterDate" />
    
    <label for="filterMonth">Filtrar por mês:</label>
    <select id="filterMonth">
      <option value="">Todos os meses</option>
    </select>
  </div>
  
  <div id="listaReunioes"></div>
</div>

<!-- Tela Gerentes -->
<div id="telaGerentes" class="hidden">
  <h2>Painel Gerentes</h2>
  <div class="filters">
    <label for="filterMonthGerente">Filtrar por mês:</label>
    <select id="filterMonthGerente">
      <option value="">Todos os meses</option>
    </select>
  </div>
  <div class="cards-container" id="cardsGerente"></div>
  <div id="detalhesGerente"></div>
</div>

<!-- Modal edição -->
<div id="modalEdit" class="hidden" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
  <div class="content">
    <h3 id="modalTitle">Editar Reunião</h3>
    <form id="formEditReuniao">
      <label>Status*:
        <select name="status" required>
          <option value="">Selecione...</option>
          <option value="AGUARDANDO RETORNO">AGUARDANDO RETORNO</option>
          <option value="FECHADO">FECHADO</option>
          <option value="NÃO TEVE INTERESSE">NÃO TEVE INTERESSE</option>
          <option value="AGUARDANDO PIX">AGUARDANDO PIX</option>
        </select>
      </label>
      <label>Data da reunião*:
        <input type="date" name="data_da_reuniao" required>
      </label>
      <label>Horário*:
        <input type="time" name="horario" required>
      </label>
      <label>Observação:
        <textarea name="observacao" rows="3"></textarea>
      </label>

      <!-- Para aceitar/sugerir/transferir -->
      <div id="acoesConsultor" class="hidden" style="margin-top:10px;">
        <button type="button" id="btnAceitar">Aceitar Reunião</button>
        <button type="button" id="btnSugerirHorario">Sugerir Outro Horário</button>
        <button type="button" id="btnTransferirConsultor">Transferir para Outro Consultor</button>
      </div>

      <button type="submit">Salvar</button>
      <button type="button" id="btnCancelEdit">Cancelar</button>
    </form>
  </div>
</div>

<script>
  // Configurações iniciais
  const SHEET_ID = 'SUA_PLANILHA_ID_AQUI'; // Insira sua planilha Google aqui
  const SHEET_RANGE = 'Sheet1!A1:Z'; // faixa da planilha para leitura e escrita

  // Emails dos usuários - ATUALIZE conforme seu uso
  const emailAngela = 'angela@seuemail.com';
  const emailAdmin = 'seuemailadmin@seuemail.com';

  // Map email consultores para nomes
  const emailsConsultores = {
    'consultor1@seuemail.com': 'Lucas',
    'consultor2@seuemail.com': 'Mariana',
    'consultor3@seuemail.com': 'João'
  };

  // Variáveis de estado
  let gapiInited = false;
  let tokenClient;
  let userProfile = null;
  let allMeetingsData = [];
  let currentView = null; // 'angela', 'consultor', 'gerente'
  let currentConsultorName = null;
  let currentEditingRowIndex = null;

  // Elementos do DOM
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const userEmailEl = document.getElementById('userEmail');
  const formAngela = document.getElementById('formAngela');
  const formAgendamento = document.getElementById('formAgendamento');
  const painelReunioes = document.getElementById('painelReunioes');
  const painelTitulo = document.getElementById('painelTitulo');
  const painelSubtitulo = document.getElementById('painelSubtitulo');
  const listaReunioes = document.getElementById('listaReunioes');
  const selectUserContainer = document.getElementById('selectUserContainer');
  const selectUser = document.getElementById('selectUser');
  const filterDate = document.getElementById('filterDate');
  const filterMonth = document.getElementById('filterMonth');
  const filterMonthGerente = document.getElementById('filterMonthGerente');
  const telaGerentes = document.getElementById('telaGerentes');
  const cardsGerente = document.getElementById('cardsGerente');
  const detalhesGerente = document.getElementById('detalhesGerente');

  const modalEdit = document.getElementById('modalEdit');
  const formEditReuniao = document.getElementById('formEditReuniao');
  const btnCancelEdit = document.getElementById('btnCancelEdit');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnClear = document.getElementById('btnClear');

  const btnAceitar = document.getElementById('btnAceitar');
  const btnSugerirHorario = document.getElementById('btnSugerirHorario');
  const btnTransferirConsultor = document.getElementById('btnTransferirConsultor');

  const selectConsultorForm = document.getElementById('selectConsultorForm');

  // Inicialização API Google e OAuth
  function initGapiClient() {
    gapi.load('client', async () => {
      await gapi.client.init({
        apiKey: 'SUA_API_KEY_GOOGLE',
        discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
      });
      gapiInited = true;
    });
  }

  function initTokenClient() {
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: 'SEU_CLIENT_ID_GOOGLE',
      scope: 'https://www.googleapis.com/auth/spreadsheets',
      callback: '', 
    });
  }

  // Login
  btnSignIn.addEventListener('click', () => {
    if (!tokenClient) return alert('Token Client não inicializado');
    tokenClient.callback = async (resp) => {
      if (resp.error !== undefined) {
        throw (resp);
      }
      await loadUserProfile();
      setupViewByEmail();
      await loadMeetings();
      if (currentView) renderMeetings();
      if(currentView === 'gerente') renderGerenteCards();
    };
    tokenClient.requestAccessToken();
  });

  // Logout
  btnSignOut.addEventListener('click', () => {
    userProfile = null;
    allMeetingsData = [];
    currentView = null;
    currentConsultorName = null;
    currentEditingRowIndex = null;
    userEmailEl.textContent = 'Não conectado';
    btnSignIn.classList.remove('hidden');
    btnSignOut.classList.add('hidden');
    formAngela.classList.add('hidden');
    painelReunioes.classList.add('hidden');
    telaGerentes.classList.add('hidden');
    selectUserContainer.classList.add('hidden');
    listaReunioes.innerHTML = '';
    filterMonth.innerHTML = '<option value="">Todos os meses</option>';
    filterMonthGerente.innerHTML = '<option value="">Todos os meses</option>';
  });

  async function loadUserProfile() {
    const token = gapi.client.getToken();
    if (!token) return;
    const userinfo = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
      headers: {
        Authorization: `Bearer ${token.access_token}`
      }
    });
    userProfile = await userinfo.json();
    userEmailEl.textContent = userProfile.email || 'Sem email';
    btnSignIn.classList.add('hidden');
    btnSignOut.classList.remove('hidden');
  }

  // Carregar reuniões da planilha
  async function loadMeetings() {
    if (!gapiInited) return;
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SHEET_ID,
        range: SHEET_RANGE
      });
      const rows = res.result.values || [];
      if (rows.length < 2) {
        allMeetingsData = [];
        alert('Nenhuma reunião encontrada.');
        return;
      }
      const headerRaw = rows[0];
      const header = headerRaw.map(normalizeHeader);
      allMeetingsData = rows.slice(1).map((r, idx) => {
        const obj = {};
        header.forEach((h, i) => obj[h] = r[i] || '');
        obj._rowId = idx; // salvar índice para edição posterior
        return obj;
      });
      hideError();
      populateSelectConsultores();
      populateFilterMonthOptions();
      populateFilterMonthOptionsGerente();
    } catch (err) {
      console.error('Erro ao carregar reuniões:', err);
      alert('Erro ao carregar dados da planilha.');
    }
  }

  // Normaliza cabeçalhos para acessar propriedades
  function normalizeHeader(h) {
    return h.toLowerCase().trim().replace(/\s+/g, '_').replace(/[^a-z0-9_]/g, '');
  }

  // Popula select consultores formulário Angela
  function populateSelectConsultores() {
    if (!selectConsultorForm) return;
    selectConsultorForm.innerHTML = '';
    Object.values(emailsConsultores).forEach(c => {
      const opt = document.createElement('option');
      opt.value = c;
      opt.textContent = c;
      selectConsultorForm.appendChild(opt);
    });
  }

  // Renderizar reuniões conforme view, filtro dia e mês
  function renderMeetings() {
    listaReunioes.innerHTML = '';
    if (!allMeetingsData.length) {
      listaReunioes.innerHTML = '<div class="muted">Nenhuma reunião disponível.</div>';
      return;
    }

    let filtered = [];

    if (currentView === 'angela') {
      filtered = allMeetingsData.filter(r => (r.email_de_quem_mandou || '').toLowerCase() === emailAngela.toLowerCase());
    } else if (currentView === 'consultor' && currentConsultorName) {
      filtered = allMeetingsData.filter(r => r.consultor.toLowerCase() === currentConsultorName.toLowerCase());
    } else if (currentView === 'gerente') {
      filtered = allMeetingsData; // Gerente vê tudo
    }

    // Filtro dia
    if (filterDate.value) {
      filtered = filtered.filter(r => r.data_da_reuniao === filterDate.value);
    }

    // Filtro mês
    if (filterMonth.value) {
      filtered = filtered.filter(r => {
        if (!r.data_da_reuniao) return false;
        return r.data_da_reuniao.startsWith(filterMonth.value);
      });
    }

    if (filtered.length === 0) {
      listaReunioes.innerHTML = '<div class="muted">Nenhuma reunião encontrada para o filtro.</div>';
      return;
    }

    filtered.forEach(r => {
      const div = document.createElement('div');
      div.classList.add('meeting-item');
      div.dataset.rowId = r._rowId;

      const header = document.createElement('div');
      header.classList.add('meeting-header');

      header.innerHTML = `<strong>${r.nome_da_empresa || '(sem empresa)'} - ${r.data_da_reuniao || ''} ${r.horario || ''}</strong>
      <span>Status: <em>${r.status || 'SEM STATUS'}</em></span>`;

      div.appendChild(header);

      const detalhes = document.createElement('div');
      detalhes.classList.add('meeting-details');
      detalhes.innerHTML = `
        <p><strong>Consultor:</strong> ${r.consultor}</p>
        <p><strong>Contato:</strong> ${r.nome || ''} (${r.funcao || ''})</p>
        <p><strong>Segmento:</strong> ${r.segmento || ''}</p>
        <p><strong>Observação:</strong> ${r.observacao || r.observacao || ''}</p>
      `;

      div.appendChild(detalhes);

      const actions = document.createElement('div');
      actions.classList.add('actions');

      // Botão abrir detalhes
      const btnToggle = document.createElement('button');
      btnToggle.textContent = 'Abrir Detalhes';
      btnToggle.addEventListener('click', () => {
        if (detalhes.style.display === 'block') {
          detalhes.style.display = 'none';
          btnToggle.textContent = 'Abrir Detalhes';
        } else {
          detalhes.style.display = 'block';
          btnToggle.textContent = 'Fechar Detalhes';
        }
      });
      actions.appendChild(btnToggle);

      // Botão editar status (somente consultores e angela)
      if (currentView === 'consultor' || currentView === 'angela') {
        const btnEdit = document.createElement('button');
        btnEdit.textContent = 'Editar';
        btnEdit.addEventListener('click', () => openEditModal(r));
        actions.appendChild(btnEdit);
      }

      // Botões específicos consultor para aceitar/sugerir/transferir
      if (currentView === 'consultor') {
        const btnAceitar = document.createElement('button');
        btnAceitar.textContent = 'Aceitar';
        btnAceitar.addEventListener('click', () => aceitarReuniao(r));
        actions.appendChild(btnAceitar);

        const btnSugerir = document.createElement('button');
        btnSugerir.textContent = 'Sugerir Outro Horário';
        btnSugerir.addEventListener('click', () => sugerirOutroHorario(r));
        actions.appendChild(btnSugerir);

        const btnTransferir = document.createElement('button');
        btnTransferir.textContent = 'Transferir para Outro Consultor';
        btnTransferir.addEventListener('click', () => transferirParaOutroConsultor(r));
        actions.appendChild(btnTransferir);
      }

      // Botões específicos Angela para aceitar sugestões/transferências
      if (currentView === 'angela' && (r.status_pendente_sugestao === 'sugestao' || r.status_pendente_sugestao === 'transferencia')) {
        const btnAceitarSugestao = document.createElement('button');
        btnAceitarSugestao.textContent = 'Aceitar Sugestão';
        btnAceitarSugestao.addEventListener('click', () => aceitarSugestao(r));
        actions.appendChild(btnAceitarSugestao);

        if (r.status_pendente_sugestao === 'transferencia') {
          const btnEscolherConsultor = document.createElement('button');
          btnEscolherConsultor.textContent = 'Escolher Novo Consultor';
          btnEscolherConsultor.addEventListener('click', () => escolherConsultorTransferencia(r));
          actions.appendChild(btnEscolherConsultor);
        }
      }

      div.appendChild(actions);

      listaReunioes.appendChild(div);
    });
  }

  // Funções ações consultor
  function aceitarReuniao(r) {
    atualizarStatusReuniao(r._rowId, 'AGUARDANDO RETORNO');
  }
  function sugerirOutroHorario(r) {
    atualizarStatusReuniao(r._rowId, 'AGUARDANDO RETORNO', true, 'sugestao');
    alert('Sua sugestão foi enviada para Angela. Aguarde a resposta.');
  }
  function transferirParaOutroConsultor(r) {
    atualizarStatusReuniao(r._rowId, 'AGUARDANDO RETORNO', true, 'transferencia');
    alert('Solicitação de transferência enviada para Angela.');
  }

  // Ações Angela
  function aceitarSugestao(r) {
    atualizarStatusReuniao(r._rowId, 'AGUARDANDO RETORNO', false, '');
    alert('Sugestão aceita.');
  }
  function escolherConsultorTransferencia(r) {
    const novoConsultor = prompt('Informe o novo consultor para essa transferência:');
    if (novoConsultor) {
      atualizarConsultor(r._rowId, novoConsultor);
      alert('Consultor alterado com sucesso.');
      loadMeetings().then(renderMeetings);
    }
  }

  // Atualiza status, pendencias e consultor na planilha
  async function atualizarStatusReuniao(rowIndex, novoStatus, pendencia = false, tipoPendencia = '') {
    if (!gapiInited) return alert('API não inicializada');
    const statusPend = pendencia ? tipoPendencia : '';
    const rows = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: SHEET_RANGE
    });
    const headerRaw = rows.result.values[0];
    const header = headerRaw.map(normalizeHeader);
    // encontrar colunas necessárias
    const idxStatus = header.indexOf('status');
    const idxPendencia = header.indexOf('status_pendente_sugestao');
    const idxRow = rowIndex + 1;
    if (idxStatus === -1 || idxPendencia === -1) {
      return alert('Colunas necessárias não encontradas na planilha.');
    }

    const values = [
      [novoStatus, statusPend]
    ];
    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SHEET_ID,
        range: `Sheet1!${colToLetter(idxStatus + 1)}${idxRow + 1}:${colToLetter(idxPendencia + 1)}${idxRow + 1}`,
        valueInputOption: 'RAW',
        resource: {values}
      });
      alert('Status atualizado!');
      await loadMeetings();
      renderMeetings();
    } catch (err) {
      alert('Erro ao atualizar status');
      console.error(err);
    }
  }

  // Atualiza consultor na planilha (para transferência)
  async function atualizarConsultor(rowIndex, novoConsultor) {
    if (!gapiInited) return alert('API não inicializada');
    const rows = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: SHEET_RANGE
    });
    const headerRaw = rows.result.values[0];
    const header = headerRaw.map(normalizeHeader);
    const idxConsultor = header.indexOf('consultor');
    const idxRow = rowIndex + 1;
    if (idxConsultor === -1) {
      return alert('Coluna Consultor não encontrada.');
    }
    const values = [[novoConsultor]];
    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SHEET_ID,
        range: `Sheet1!${colToLetter(idxConsultor + 1)}${idxRow + 1}`,
        valueInputOption: 'RAW',
        resource: {values}
      });
      alert('Consultor atualizado!');
      await loadMeetings();
      renderMeetings();
    } catch (err) {
      alert('Erro ao atualizar consultor');
      console.error(err);
    }
  }

  // Função auxiliar para converter índice da coluna para letra (ex: 1 -> A, 27 -> AA)
  function colToLetter(col) {
    let letter = '';
    while (col > 0) {
      let mod = (col - 1) % 26;
      letter = String.fromCharCode(65 + mod) + letter;
      col = Math.floor((col - mod) / 26);
    }
    return letter;
  }

  // Modal editar
  function openEditModal(reuniao) {
    currentEditingRowIndex = reuniao._rowId;
    modalEdit.classList.remove('hidden');
    const f = formEditReuniao;
    f.status.value = reuniao.status || '';
    f.data_da_reuniao.value = reuniao.data_da_reuniao || '';
    f.horario.value = reuniao.horario || '';
    f.observacao.value = reuniao.observacao || '';
    
    // Mostrar ou esconder as ações extras se for consultor
    if(currentView === 'consultor') {
      document.getElementById('acoesConsultor').classList.remove('hidden');
    } else {
      document.getElementById('acoesConsultor').classList.add('hidden');
    }
  }
  btnCancelEdit.addEventListener('click', () => {
    modalEdit.classList.add('hidden');
    currentEditingRowIndex = null;
  });

  formEditReuniao.addEventListener('submit', async e => {
    e.preventDefault();
    if (!currentEditingRowIndex && currentEditingRowIndex !== 0) return;
    if (!gapiInited) return alert('API não inicializada');
    const status = formEditReuniao.status.value;
    const dataReuniao = formEditReuniao.data_da_reuniao.value;
    const horario = formEditReuniao.horario.value;
    const obs = formEditReuniao.observacao.value;

    // Atualiza a planilha (colunas Status, Data da Reunião, Horário, Observação)
    const rows = await gapi.client.sheets.spreadsheets.values.get({
      spreadsheetId: SHEET_ID,
      range: SHEET_RANGE
    });
    const headerRaw = rows.result.values[0];
    const header = headerRaw.map(normalizeHeader);
    const idxStatus = header.indexOf('status');
    const idxData = header.indexOf('data_da_reuniao');
    const idxHorario = header.indexOf('horario');
    const idxObs = header.indexOf('observacao');
    const idxRow = currentEditingRowIndex + 1;
    if ([idxStatus, idxData, idxHorario, idxObs].includes(-1)) {
      return alert('Colunas necessárias não encontradas na planilha.');
    }
    const values = [[status, dataReuniao, horario, obs]];
    try {
      await gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SHEET_ID,
        range: `Sheet1!${colToLetter(idxStatus + 1)}${idxRow + 1}:${colToLetter(idxObs + 1)}${idxRow + 1}`,
        valueInputOption: 'RAW',
        resource: {values}
      });
      alert('Reunião atualizada com sucesso!');
      modalEdit.classList.add('hidden');
      currentEditingRowIndex = null;
      await loadMeetings();
      renderMeetings();
    } catch (err) {
      alert('Erro ao atualizar reunião');
      console.error(err);
    }
  });

  // Formulário Angela salvar
  btnSalvar.addEventListener('click', async () => {
    if (!gapiInited) return alert('API não inicializada');
    const formData = new FormData(formAgendamento);
    // Validações mínimas
    if(!formData.get('data_contato') || !formData.get('empresa') || !formData.get('segmento') || !formData.get('uf') || !formData.get('prospeccao') || !formData.get('nome') || !formData.get('funcao') || !formData.get('contato') || !formData.get('reuniao') || !formData.get('data_reuniao') || !formData.get('horario') || !formData.get('consultor')) {
      return alert('Preencha todos os campos obrigatórios.');
    }
    // Monta linha para planilha
    const novaLinha = [
      new Date().toISOString().split('T')[0],            // Data do agendamento = hoje
      formData.get('data_contato'),
      formData.get('empresa'),
      formData.get('cnpj'),
      formData.get('qtd_lojas'),
      formData.get('segmento'),
      formData.get('uf'),
      formData.get('prospeccao'),
      formData.get('nome'),
      formData.get('funcao'),
      formData.get('contato'),
      formData.get('reuniao'),
      formData.get('data_reuniao'),
      formData.get('horario'),
      formData.get('consultor'),
      '', // Numero do consultor (não usado)
      formData.get('observacoes'),
      userProfile.email,
      'AGUARDANDO RETORNO', // status inicial fixo
      '', // status_pendente_sugestao vazio inicialmente
      '' // consultor_sugerido vazio inicialmente
    ];
    try {
      await gapi.client.sheets.spreadsheets.values.append({
        spreadsheetId: SHEET_ID,
        range: 'Sheet1!A1:Z1',
        valueInputOption: 'RAW',
        insertDataOption: 'INSERT_ROWS',
        resource: {values: [novaLinha]}
      });
      alert('Reunião agendada com sucesso!');
      formAgendamento.reset();
      await loadMeetings();
      renderMeetings();
    } catch (err) {
      console.error(err);
      alert('Erro ao salvar na planilha.');
    }
  });

  btnClear.addEventListener('click', () => formAgendamento.reset());

  // Preencher filtro mês opções para meses disponíveis nas reuniões
  function populateFilterMonthOptions() {
    const meses = new Set();
    allMeetingsData.forEach(r => {
      if (r.data_da_reuniao && r.data_da_reuniao.length >= 7) {
        meses.add(r.data_da_reuniao.slice(0,7));
      }
    });
    filterMonth.innerHTML = '<option value="">Todos os meses</option>';
    Array.from(meses).sort().forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      filterMonth.appendChild(opt);
    });
  }
  // Similar para gerente
  function populateFilterMonthOptionsGerente() {
    const meses = new Set();
    allMeetingsData.forEach(r => {
      if (r.data_da_reuniao && r.data_da_reuniao.length >= 7) {
        meses.add(r.data_da_reuniao.slice(0,7));
      }
    });
    filterMonthGerente.innerHTML = '<option value="">Todos os meses</option>';
    Array.from(meses).sort().forEach(m => {
      const opt = document.createElement('option');
      opt.value = m;
      opt.textContent = m;
      filterMonthGerente.appendChild(opt);
    });
  }

  filterDate.addEventListener('change', renderMeetings);
  filterMonth.addEventListener('change', renderMeetings);
  filterMonthGerente.addEventListener('change', renderGerenteCards);

  // Exibir dados gerentes
  function renderGerenteCards() {
    telaGerentes.classList.remove('hidden');
    painelReunioes.classList.add('hidden');
    formAngela.classList.add('hidden');

    // Filtra por mês
    let dadosFiltrados = allMeetingsData;
    if(filterMonthGerente.value) {
      dadosFiltrados = dadosFiltrados.filter(r => r.data_da_reuniao && r.data_da_reuniao.startsWith(filterMonthGerente.value));
    }

    // Estatísticas
    const total = dadosFiltrados.length;
    const agendadas = dadosFiltrados.filter(r => r.status === 'AGUARDANDO RETORNO').length;
    const fechadas = dadosFiltrados.filter(r => r.status === 'FECHADO').length;
    const naoInteresse = dadosFiltrados.filter(r => r.status === 'NÃO TEVE INTERESSE').length;
    const aguardandoPix = dadosFiltrados.filter(r => r.status === 'AGUARDANDO PIX').length;
    const transferidas = dadosFiltrados.filter(r => r.status_pendente_sugestao === 'transferencia').length;

    cardsGerente.innerHTML = `
      <div class="card"><strong>Total reuniões:</strong> ${total}</div>
      <div class="card"><strong>AGUARDANDO RETORNO:</strong> ${agendadas}</div>
      <div class="card"><strong>FECHADO:</strong> ${fechadas}</div>
      <div class="card"><strong>NÃO TEVE INTERESSE:</strong> ${naoInteresse}</div>
      <div class="card"><strong>AGUARDANDO PIX:</strong> ${aguardandoPix}</div>
      <div class="card"><strong>Transferidas (pendentes):</strong> ${transferidas}</div>
      <button onclick="mostrarDetalhesGerente()">Exibir Detalhes</button>
    `;
    detalhesGerente.innerHTML = '';
  }

  // Mostrar detalhes filtrados para gerente
  function mostrarDetalhesGerente() {
    let dadosFiltrados = allMeetingsData;
    if(filterMonthGerente.value) {
      dadosFiltrados = dadosFiltrados.filter(r => r.data_da_reuniao && r.data_da_reuniao.startsWith(filterMonthGerente.value));
    }
    if(dadosFiltrados.length === 0) {
      detalhesGerente.innerHTML = '<p>Nenhuma reunião para mostrar.</p>';
      return;
    }
    let html = '<h3>Detalhes das Reuniões:</h3>';
    dadosFiltrados.forEach(r => {
      html += `<div class="meeting-item">
        <strong>${r.nome_da_empresa || '(sem empresa)'} - ${r.data_da_reuniao || ''} ${r.horario || ''}</strong><br/>
        Status: ${r.status || ''} | Consultor: ${r.consultor || ''}<br/>
        Contato: ${r.nome || ''} | Segmento: ${r.segmento || ''}<br/>
        Observação: ${r.observacao || ''}<br/>
      </div>`;
    });
    detalhesGerente.innerHTML = html;
  }

  // Setup da tela conforme usuário logado
  function setupViewByEmail() {
    const email = userProfile.email.toLowerCase();
    btnSignIn.classList.add('hidden');
    btnSignOut.classList.remove('hidden');
    userEmailEl.textContent = email;

    if(email === emailAngela.toLowerCase()) {
      // Angela
      currentView = 'angela';
      formAngela.classList.remove('hidden');
      painelReunioes.classList.remove('hidden');
      painelTitulo.textContent = 'Reuniões agendadas por Angela';
      painelSubtitulo.textContent = 'Hoje';
      telaGerentes.classList.add('hidden');
      selectUserContainer.classList.remove('hidden');

      // Preencher selectUser
      selectUser.innerHTML = `
        <option value="angela" selected>Angela</option>
        ${Object.entries(emailsConsultores).map(([e,n]) => `<option value="${n.toLowerCase()}">${n}</option>`).join('')}
        <option value="gerente">Gerente</option>
      `;

      selectUser.value = 'angela';
      currentConsultorName = null;
    } else if(Object.keys(emailsConsultores).includes(email)) {
      // Consultor
      currentView = 'consultor';
      currentConsultorName = emailsConsultores[email];
      formAngela.classList.add('hidden');
      painelReunioes.classList.remove('hidden');
      painelTitulo.textContent = `Reuniões de ${currentConsultorName}`;
      painelSubtitulo.textContent = '';
      telaGerentes.classList.add('hidden');
      selectUserContainer.classList.add('hidden');
    } else if(email === emailAdmin.toLowerCase()) {
      // Gerente / Admin
      currentView = 'gerente';
      formAngela.classList.add('hidden');
      painelReunioes.classList.add('hidden');
      telaGerentes.classList.remove('hidden');
      selectUserContainer.classList.remove('hidden');

      // Preencher selectUser para admin
      selectUser.innerHTML = `
        <option value="gerente" selected>Gerente</option>
        <option value="angela">Angela</option>
        ${Object.entries(emailsConsultores).map(([e,n]) => `<option value="${n.toLowerCase()}">${n}</option>`).join('')}
      `;
      selectUser.value = 'gerente';
      currentConsultorName = null;
      renderGerenteCards();
    } else {
      alert('Usuário não autorizado');
      btnSignOut.click();
    }
  }

  selectUser.addEventListener('change', () => {
    const val = selectUser.value;
    if(val === 'angela') {
      currentView = 'angela';
      formAngela.classList.remove('hidden');
      painelReunioes.classList.remove('hidden');
      painelTitulo.textContent = 'Reuniões agendadas por Angela';
      painelSubtitulo.textContent = 'Hoje';
      telaGerentes.classList.add('hidden');
      currentConsultorName = null;
      renderMeetings();
    } else if(val === 'gerente') {
      currentView = 'gerente';
      formAngela.classList.add('hidden');
      painelReunioes.classList.add('hidden');
      telaGerentes.classList.remove('hidden');
      currentConsultorName = null;
      renderGerenteCards();
    } else if(val && Object.values(emailsConsultores).map(c => c.toLowerCase()).includes(val)) {
      currentView = 'consultor';
      currentConsultorName = val.charAt(0).toUpperCase() + val.slice(1); // capitaliza
      formAngela.classList.add('hidden');
      painelReunioes.classList.remove('hidden');
      painelTitulo.textContent = `Reuniões de ${currentConsultorName}`;
      painelSubtitulo.textContent = '';
      telaGerentes.classList.add('hidden');
      renderMeetings();
    } else {
      formAngela.classList.add('hidden');
      painelReunioes.classList.add('hidden');
      telaGerentes.classList.add('hidden');
      currentView = null;
      currentConsultorName = null;
    }
  });

  // Inicialização Google API
  window.onload = () => {
    initGapiClient();
    initTokenClient();
  };
</script>

</body>
</html>
