<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Reuniões SouFácil - Sistema</title>
<style>
  :root {--accent:#007aff;--muted:#6b7280}
  body {font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:#f3f6fb; margin:0; padding:24px; display:flex; justify-content:center;}
  .app {width:1100px; max-width:96%; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:14px; box-shadow:0 10px 30px rgba(18,38,63,0.08); padding:20px;}
  header {display:flex; justify-content:space-between; align-items:center; margin-bottom:18px;}
  .brand {display:flex; gap:12px; align-items:center;}
  .logo {width:48px; height:48px; background:linear-gradient(135deg,#007aff,#4cc3ff); border-radius:12px; color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700;}
  h1 {font-size:18px; margin:0;}
  .small {color:var(--muted); font-size:13px;}
  select,input,textarea,button {font-size:14px; border-radius:8px;}
  label {display:block; font-size:13px; color:#333; margin-top:10px;}
  input,select,textarea {width:100%; padding:10px; border:1px solid #e6e9ef; margin-top:6px;}
  button {background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600;}
  .btn-secondary {background:#eee; color:#111;}
  .card {background:#fff; border-radius:12px; padding:14px; box-shadow:0 6px 18px rgba(15,30,60,0.04); margin-bottom: 20px;}
  .muted {color:var(--muted); font-size:13px;}
  .meeting-item {border-bottom: 1px solid #eee; padding: 8px 0;}
  .meeting-header {display: flex; align-items: center; gap: 12px; flex-wrap: wrap;}
  .meeting-header strong {flex-grow: 1;}
  .meeting-header .muted {font-size: 13px; color: var(--muted);}
  .meeting-header button {background: var(--accent); color: white; border: none; border-radius: 8px; padding: 5px 10px; cursor: pointer; flex-shrink: 0;}
  .meeting-details {padding: 8px 12px; background: #f9fbff; border-radius: 8px; margin-top: 6px; display: none; font-size: 14px;}
  .meeting-details p {margin: 4px 0;}
  #selectUser, .date-filter {margin-bottom: 12px;}
  .actions {display: flex; gap: 6px; margin-top: 8px;}
  .actions button {padding: 5px 10px; font-size: 13px;}
  .hidden {display:none;}
  .error {color: red; margin-top: 10px;}
  .date-filter {display: flex; gap: 10px; align-items: end;}
  .date-filter > div {flex: 1;}
  .date-filter button {margin-top: 6px; padding: 8px 12px;}
</style>
</head>
<body>
<div class="app">
  <header>
    <div class="brand">
      <div class="logo">SF</div>
      <div>
        <h1>Reuniões SouFácil - Sistema</h1>
        <div class="small" id="userEmail">Não conectado</div>
      </div>
    </div>
    <div style="display:flex; gap:10px; align-items:center;">
      <select id="selectUser" class="hidden" title="Selecionar tela para visualização"></select>
      <button id="btnSignIn">Entrar com Google</button>
      <button id="btnSignOut" class="btn-secondary hidden">Sair</button>
    </div>
  </header>

  <!-- Área para formulário Angela -->
  <div id="formAngela" class="card hidden">
    <div><div class="small">Formulário de agendamento — Angela</div></div>
    <form id="formAgendamento" style="margin-top:12px">
      <label>Data do contato</label><input type="date" name="data_contato" required>
      <label>Nome da empresa</label><input type="text" name="empresa" required>
      <label>CNPJ</label><input type="text" name="cnpj" placeholder="00.000.000/0000-00">
      <label>Quantidade de lojas</label><input type="number" name="qtd_lojas" min="0">
      <label>Segmento</label>
      <select name="segmento" required>
        <option value="">Selecione</option>
        <option>Móveis</option><option>Óticas</option><option>Roupas</option><option>Calçados</option>
        <option>Celular</option><option>Mercado</option><option>Farmácia</option><option>Eletro</option>
        <option>Utilidades</option><option>Distribuidora</option><option>Clínica</option><option>Conveniência</option>
      </select>
      <label>UF</label>
      <select name="uf" required>
        <option value="">Selecione</option>
        <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option>
        <option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option>
        <option>MG</option><option>MS</option><option>MT</option><option>PA</option><option>PB</option>
        <option>PE</option><option>PI</option><option>PR</option><option>RJ</option><option>RN</option>
        <option>RO</option><option>RR</option><option>RS</option><option>SC</option><option>SE</option>
        <option>SP</option><option>TO</option>
      </select>
      <label>Prospecção</label>
      <select name="prospeccao" required>
        <option value="">Selecione</option>
        <option>Leads</option><option>Internet</option><option>Indicação</option><option>Ligação</option><option>Visita</option><option>Já é cliente</option>
      </select>
      <label>Nome</label><input type="text" name="nome" required>
      <label>Função</label>
      <select name="funcao" required>
        <option value="">Selecione</option>
        <option>Funcionário</option><option>Vendedor</option><option>Proprietário</option><option>Gerente</option><option>Financeiro</option>
      </select>
      <label>Contato</label><input type="tel" name="contato" placeholder="+55 (DDD) 90000-0000" required>
      <label>Reunião</label>
      <select name="reuniao" id="tipoReuniao" required>
        <option value="">Selecione</option>
        <option value="Ligação">Ligação</option>
        <option value="Whats">Whats</option>
        <option value="Meet">Meet</option>
      </select>
      <div style="display:flex; gap:10px;">
        <div style="flex:1;">
          <label>Data da Reunião</label><input type="date" name="data_reuniao" required>
        </div>
        <div style="flex:1;">
          <label>Horário</label><input type="time" name="horario" required>
        </div>
      </div>
      <label>Consultor</label>
      <select name="consultor" id="consultorSelect" required>
        <option value="">Selecione</option>
        <option value="Glaucia">Glaucia — +55 17 99274-1145</option>
        <option value="Leticia">Leticia — +55 17 99202-1249</option>
        <option value="Marcelo">Marcelo — +55 17 99272-4400</option>
        <option value="Gabriel">Gabriel — +55 17 99273-9551</option>
      </select>
      <label>Observações</label><textarea name="observacoes" rows="3" placeholder="Observações..."></textarea>

      <div class="actions" style="margin-top:10px;">
        <button id="btnSalvar" type="button">Salvar (Planilha)</button>
        <button id="btnWhats" type="button">Enviar WhatsApp (Comprovante)</button>
        <button id="btnClear" type="button" class="btn-secondary">Limpar</button>
      </div>
    </form>
  </div>

  <!-- Área Painel Consultores ou Angela -->
  <div id="painelReunioes" class="card hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
      <div>
        <div class="small" id="painelTitulo">Reuniões</div>
        <strong id="painelSubtitulo">Hoje</strong>
      </div>
      <div class="date-filter">
        <div>
          <label for="startDate">Data inicial:</label>
          <input type="date" id="startDate" placeholder="Data inicial">
        </div>
        <div>
          <label for="endDate">Data final:</label>
          <input type="date" id="endDate" placeholder="Data final">
        </div>
        <div>
          <button type="button" id="btnFilter">Filtrar</button>
        </div>
      </div>
    </div>

    <div id="listaReunioes" style="margin-top:10px;"></div>
    <div id="errorMsg" class="error hidden"></div>
  </div>

  <!-- Modal editar reunião -->
  <div id="modalEdit" class="card hidden" style="position:fixed; top:50%; left:50%; transform: translate(-50%, -50%); width: 480px; max-width: 95%; z-index: 9999;">
    <h3>Editar reunião</h3>
    <form id="formEditReuniao">
      <label>Status</label>
      <select name="status" required>
        <option value="">Selecione</option>
        <option>Agendada</option>
        <option>Confirmada</option>
        <option>Realizada</option>
        <option>Cancelada</option>
      </select>

      <label>Data da Reunião</label>
      <input type="date" name="data_da_reuniao" required>

      <label>Horário</label>
      <input type="time" name="horario" required>

      <label>Observações</label>
      <textarea name="observacao" rows="3"></textarea>

      <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:10px;">
        <button type="submit">Salvar</button>
        <button type="button" id="btnCancelEdit" class="btn-secondary">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script src="https://accounts.google.com/gsi/client" async defer></script>
<script src="https://apis.google.com/js/api.js" async defer></script>
<script>
  const CLIENT_ID = '689575420157-di4d81kgeo6tnaf70edsi6sii5523sev.apps.googleusercontent.com';
  const API_KEY = 'AIzaSyAiU6bMImfPaQLJj8nVO4V0Je67sSyvGTo';
  const SHEET_ID = '1-kcIEyUDiBWcGEUKxqotqlpyT-hIta5k3Cx1_mFEUIg';
  const SHEET_RANGE = 'Sheet1!A1:Z9999';

  const btnSignIn = document.getElementById('btnSignIn' );
  const btnSignOut = document.getElementById('btnSignOut');
  const userEmailEl = document.getElementById('userEmail');
  const selectUser = document.getElementById('selectUser');

  const formAngela = document.getElementById('formAngela');
  const formAgendamento = document.getElementById('formAgendamento');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnWhats = document.getElementById('btnWhats');
  const btnClear = document.getElementById('btnClear');

  const painelReunioes = document.getElementById('painelReunioes');
  const painelTitulo = document.getElementById('painelTitulo');
  const painelSubtitulo = document.getElementById('painelSubtitulo');
  const listaReunioes = document.getElementById('listaReunioes');
  const startDate = document.getElementById('startDate');
  const endDate = document.getElementById('endDate');
  const btnFilter = document.getElementById('btnFilter');
  const errorMsg = document.getElementById('errorMsg');

  const modalEdit = document.getElementById('modalEdit');
  const formEditReuniao = document.getElementById('formEditReuniao');
  const btnCancelEdit = document.getElementById('btnCancelEdit');

  let tokenClient;
  let gapiInited = false;
  let userProfile = null;
  let allMeetingsData = [];
  let currentView = null; // 'angela' ou consultor
  let currentConsultorName = null; // nome consultor se for consultor

  // Emails fixos (coloque os reais que usam)
  const emailAngela = 'angela@exemplo.com';
  const emailsConsultores = {
    'glaucia@exemplo.com': 'Glaucia',
    'leticia@exemplo.com': 'Leticia',
    'marcelo@exemplo.com': 'Marcelo',
    'gabriel@exemplo.com': 'Gabriel'
  };
  const emailAdmin = 'felipesoufacil@gmail.com'; // você para escolher telas

  // Mapping status possíveis para facilitar
  const statusOptions = ['Agendada', 'Confirmada', 'Realizada', 'Cancelada'];

  // Utilitário para formatar datas yyyy-mm-dd -> dd/mm/yyyy
  function formatDateBR(iso) {
    if(!iso) return '-';
    const [y,m,d] = iso.split('-');
    return `${d}/${m}/${y}`;
  }

  // Normalize header para campo chave
  function normalizeHeader(header){
    return header.toLowerCase().trim().replace(/\s+/g, '_').normalize('NFD').replace(/[\u0300-\u036f]/g, "");
  }

  // Inicia GAPI client
  function initGapiClient(){
    gapi.load('client', async () => {
      try {
        await gapi.client.init({
          apiKey: API_KEY,
          discoveryDocs: [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
          ]
        } );
        gapiInited = true;
        await loadMeetings();
      } catch (err) {
        console.error('Erro ao inicializar GAPI', err);
        showError('Erro ao inicializar APIs Google.');
      }
    });
  }

  // Inicializa Token client OAuth
  function initTokenClient(){
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar.events openid email profile',
      callback: async (resp ) => {
        if(resp.error){
          console.error('Erro no token', resp);
          alert('Erro na autenticação: ' + resp.error);
          return;
        }
        try {
          const r = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {headers: {Authorization: 'Bearer ' + resp.access_token}} );
          userProfile = await r.json();
          userEmailEl.textContent = userProfile.email;
          btnSignIn.classList.add('hidden');
          btnSignOut.classList.remove('hidden');
          await loadMeetings();
          setupViewByEmail();
        } catch (e) {
          console.error(e);
          alert('Erro ao buscar perfil.');
        }
      }
    });
  }

  btnSignIn.addEventListener('click', () => {
    if(!tokenClient) return alert('Cliente OAuth não iniciado');
    tokenClient.requestAccessToken();
  });

  btnSignOut.addEventListener('click', () => {
    userProfile = null;
    allMeetingsData = [];
    currentView = null;
    currentConsultorName = null;
    userEmailEl.textContent = 'Não conectado';
    btnSignIn.classList.remove('hidden');
    btnSignOut.classList.add('hidden');
    formAngela.classList.add('hidden');
    painelReunioes.classList.add('hidden');
    selectUser.classList.add('hidden');
    listaReunioes.innerHTML = '';
    startDate.value = '';
    endDate.value = '';
  });

  // Carregar reuniões da planilha
  async function loadMeetings(){
    if(!gapiInited) return;
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SHEET_ID,
        range: SHEET_RANGE
      });
      const rows = res.result.values || [];
      if(rows.length < 2){
        allMeetingsData = [];
        showError('Nenhuma reunião encontrada.');
        return;
      }
      const headerRaw = rows[0];
      const header = headerRaw.map(normalizeHeader);
      allMeetingsData = rows.slice(1).map(r => {
        const obj = {};
        header.forEach((h,i) => obj[h] = r[i] || '');
        return obj;
      });
      hideError();
    } catch(err) {
      console.error('Erro ao carregar reuniões:', err);
      showError('Erro ao carregar dados da planilha.');
    }
  }

  // Nova função de filtro por período
  function applyDateFilter() {
    const start = startDate.value; // yyyy-mm-dd
    const end = endDate.value;     // yyyy-mm-dd
    
    let filtered = [];

    if(currentView === 'angela'){
      // Angela vê reuniões que ela agendou (email_de_quem_mandou contendo "angela")
      filtered = allMeetingsData.filter(r => (r.email_de_quem_mandou || '').toLowerCase().includes('angela'));
    } else if(currentView === 'consultor' && currentConsultorName){
      // Consultor vê reuniões dele (campo consultor = nome)
      filtered = allMeetingsData.filter(r => r.consultor.toLowerCase() === currentConsultorName.toLowerCase());
    } else {
      return;
    }

    // Aplicar filtro de período
    if(start && !end) {
      // Filtra um único dia
      filtered = filtered.filter(r => r.data_da_reuniao === start);
    } else if(start && end) {
      // Filtra intervalo
      filtered = filtered.filter(r => r.data_da_reuniao >= start && r.data_da_reuniao <= end);
    }
    // Se não há filtro, mantém todos

    renderMeetings({view: currentView, consultor: currentConsultorName, data: filtered});
  }

  // Montar lista reuniões de acordo com view e filtro
  function renderMeetings({view, consultor=null, filterDate=null, data=null}){
    listaReunioes.innerHTML = '';

    let filtered = data || [];

    // Se não foi passada uma lista filtrada, usar a lógica original
    if(!data) {
      if(!allMeetingsData.length){
        listaReunioes.innerHTML = '<div class="muted">Nenhuma reunião disponível.</div>';
        return;
      }

      if(view === 'angela'){
        // Angela vê reuniões que ela agendou (email_de_quem_mandou contendo "angela")
        filtered = allMeetingsData.filter(r => (r.email_de_quem_mandou || '').toLowerCase().includes('angela'));
      } else if(view === 'consultor' && consultor){
        // Consultor vê reuniões dele (campo consultor = nome)
        filtered = allMeetingsData.filter(r => r.consultor.toLowerCase() === consultor.toLowerCase());
      } else {
        listaReunioes.innerHTML = '<div class="muted">Nenhuma visualização disponível para este usuário.</div>';
        return;
      }

      // Filtrar por data se passado (comportamento original)
      if(filterDate){
        filtered = filtered.filter(r => r.data_da_reuniao === filterDate);
        painelSubtitulo.textContent = 'Dia: ' + formatDateBR(filterDate);
      } else {
        // Por padrão mostrar reuniões de hoje
        const hoje = new Date().toISOString().slice(0,10);
        filtered = filtered.filter(r => r.data_da_reuniao === hoje);
        painelSubtitulo.textContent = 'Hoje';
      }
    } else {
      // Se foi passada uma lista filtrada, atualizar o subtítulo
      const start = startDate.value;
      const end = endDate.value;
      if(start && end) {
        painelSubtitulo.textContent = `Período: ${formatDateBR(start)} - ${formatDateBR(end)}`;
      } else if(start) {
        painelSubtitulo.textContent = `Dia: ${formatDateBR(start)}`;
      } else {
        painelSubtitulo.textContent = 'Todas as reuniões';
      }
    }

    // Ordenar por horário
    filtered.sort((a,b) => a.horario.localeCompare(b.horario));

    if(filtered.length === 0){
      listaReunioes.innerHTML = '<div class="muted">Nenhuma reunião encontrada para o filtro.</div>';
      return;
    }

    // Criar elementos para reuniões
    filtered.forEach((row, idx) => {
      listaReunioes.appendChild(createMeetingElement(row, idx));
    });
  }

  // Event listeners para o novo filtro
  btnFilter.addEventListener('click', applyDateFilter);
  
  // Opcional: filtrar automaticamente quando as datas mudarem
  startDate.addEventListener('change', applyDateFilter);
  endDate.addEventListener('change', applyDateFilter);

  // Criar elemento reunião
  function createMeetingElement(row, idx){
    const div = document.createElement('div');
    div.className = 'meeting-item';

    div.innerHTML = `
      <div class="meeting-header">
        <strong>${row.nome_da_empresa || '-'}</strong>
        <span class="muted">${row.horario || '-'} | ${formatDateBR(row.data_da_reuniao)}</span>
        <button onclick="toggleDetails(${idx})">Ver detalhes</button>
      </div>
      <div class="meeting-details" id="details-${idx}">
        <p><strong>Nome:</strong> ${row.nome || '-'}</p>
        <p><strong>Contato:</strong> ${row.contato || '-'}</p>
        <p><strong>Consultor:</strong> ${row.consultor || '-'}</p>
        <p><strong>Status:</strong> ${row.status || 'Agendada'}</p>
        <p><strong>Tipo:</strong> ${row.reuniao || '-'}</p>
        <p><strong>Observações:</strong> ${row.observacao || row.observacoes || '-'}</p>
        <div class="actions">
          <button onclick="editMeeting(${idx})">Editar</button>
          <button onclick="sendWhatsApp('${row.contato}', '${row.nome}', '${row.data_da_reuniao}', '${row.horario}')">WhatsApp</button>
        </div>
      </div>
    `;

    return div;
  }

  // Função para alternar detalhes
  function toggleDetails(idx) {
    const details = document.getElementById(`details-${idx}`);
    details.style.display = details.style.display === 'none' ? 'block' : 'none';
  }

  // Função para editar reunião
  function editMeeting(idx) {
    // Implementar lógica de edição
    console.log('Editar reunião:', idx);
    modalEdit.classList.remove('hidden');
  }

  // Função para enviar WhatsApp
  function sendWhatsApp(contato, nome, data, horario) {
    const message = `Olá ${nome}! Confirmando nossa reunião para ${formatDateBR(data)} às ${horario}. Aguardo você!`;
    const whatsappUrl = `https://wa.me/${contato.replace(/\D/g, '' )}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  }

  // Função para mostrar erro
  function showError(message) {
    errorMsg.textContent = message;
    errorMsg.classList.remove('hidden');
  }

  // Função para esconder erro
  function hideError() {
    errorMsg.classList.add('hidden');
  }

  // Configurar visualização baseada no email
  function setupViewByEmail() {
    if (!userProfile) return;

    const email = userProfile.email.toLowerCase();

    if (email.includes('angela') || email === emailAngela) {
      currentView = 'angela';
      formAngela.classList.remove('hidden');
      painelReunioes.classList.remove('hidden');
      painelTitulo.textContent = 'Reuniões — Angela';
      renderMeetings({view: 'angela'});
    } else if (emailsConsultores[email]) {
      currentView = 'consultor';
      currentConsultorName = emailsConsultores[email];
      painelReunioes.classList.remove('hidden');
      painelTitulo.textContent = `Reuniões — ${currentConsultorName}`;
      renderMeetings({view: 'consultor', consultor: currentConsultorName});
    } else if (email === emailAdmin) {
      // Admin pode escolher visualização
      selectUser.classList.remove('hidden');
      selectUser.innerHTML = `
        <option value="">Selecionar visualização</option>
        <option value="angela">Angela</option>
        <option value="glaucia">Glaucia</option>
        <option value="leticia">Leticia</option>
        <option value="marcelo">Marcelo</option>
        <option value="gabriel">Gabriel</option>
      `;
      
      selectUser.addEventListener('change', (e) => {
        const selected = e.target.value;
        if (selected === 'angela') {
          currentView = 'angela';
          currentConsultorName = null;
          formAngela.classList.remove('hidden');
          painelReunioes.classList.remove('hidden');
          painelTitulo.textContent = 'Reuniões — Angela';
          renderMeetings({view: 'angela'});
        } else if (selected) {
          currentView = 'consultor';
          currentConsultorName = selected.charAt(0).toUpperCase() + selected.slice(1);
          formAngela.classList.add('hidden');
          painelReunioes.classList.remove('hidden');
          painelTitulo.textContent = `Reuniões — ${currentConsultorName}`;
          renderMeetings({view: 'consultor', consultor: currentConsultorName});
        }
      });
    }
  }

  // Cancelar edição
  btnCancelEdit.addEventListener('click', () => {
    modalEdit.classList.add('hidden');
  });

  // Limpar formulário
  btnClear.addEventListener('click', () => {
    formAgendamento.reset();
  });

  // Inicializar quando a página carregar
  window.addEventListener('load', () => {
    initGapiClient();
    initTokenClient();
  });
</script>
</body>
</html>
