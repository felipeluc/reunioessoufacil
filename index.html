<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reuni√µes ‚Äî SouF√°cil</title>
  <style>
    :root{--accent:#007aff;--muted:#6b7280}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial; background:#f3f6fb; margin:0; padding:24px; display:flex; justify-content:center}
    .app{width:1100px; max-width:96%; background:linear-gradient(180deg,#fff,#fbfdff); border-radius:14px; box-shadow:0 10px 30px rgba(18,38,63,0.08); padding:20px;}
    header{display:flex; justify-content:space-between; align-items:center; margin-bottom:18px}
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:48px;height:48px;background:linear-gradient(135deg,#007aff,#4cc3ff); border-radius:12px;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:700}
    h1{font-size:18px;margin:0}
    .small{color:var(--muted);font-size:13px}
    .cols{display:grid; grid-template-columns:420px 1fr; gap:16px}
    .card{background:#fff;border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,30,60,0.04)}
    label{display:block;font-size:13px;color:#333;margin-top:10px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #e6e9ef;border-radius:8px;margin-top:6px;font-size:14px}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:600}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:8px}
    .row > *{flex:1}
    .actions { display:flex; gap:8px; margin-top:12px; }
    .btn-secondary { background:#eee; color:#111; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="logo">SF</div>
        <div>
          <h1>Reuni√µes ‚Äî SouF√°cil</h1>
          <div class="small">Autentique com Google para gravar no Sheets / Calendar</div>
        </div>
      </div>

      <div style="display:flex; gap:10px; align-items:center">
        <div id="userEmail" class="muted">N√£o conectado</div>
        <button id="btnSignIn">Entrar com Google</button>
        <button id="btnSignOut" class="btn-secondary" style="display:none">Sair</button>
      </div>
    </header>

    <div class="cols">
      <!-- Form -->
      <div class="card">
        <div><div class="small">Formul√°rio de agendamento ‚Äî Angela</div></div>

        <form id="formAgendamento" style="margin-top:12px">
          <label>Data do contato</label>
          <input type="date" name="data_contato" required>

          <label>Nome da empresa</label>
          <input type="text" name="empresa" required>

          <label>CNPJ</label>
          <input type="text" name="cnpj" placeholder="00.000.000/0000-00">

          <label>Quantidade de lojas</label>
          <input type="number" name="qtd_lojas" min="0">

          <label>Segmento</label>
          <select name="segmento" required>
            <option value="">Selecione</option>
            <option>M√≥veis</option><option>√ìticas</option><option>Roupas</option><option>Cal√ßados</option>
            <option>Celular</option><option>Mercado</option><option>Farm√°cia</option><option>Eletro</option>
            <option>Utilidades</option><option>Distribuidora</option><option>Cl√≠nica</option><option>Conveni√™ncia</option>
          </select>

          <label>UF</label>
          <select name="uf" required>
            <option value="">Selecione</option>
            <option>AC</option><option>AL</option><option>AP</option><option>AM</option><option>BA</option>
            <option>CE</option><option>DF</option><option>ES</option><option>GO</option><option>MA</option>
            <option>MG</option><option>MS</option><option>MT</option><option>PA</option><option>PB</option>
            <option>PE</option><option>PI</option><option>PR</option><option>RJ</option><option>RN</option>
            <option>RO</option><option>RR</option><option>RS</option><option>SC</option><option>SE</option>
            <option>SP</option><option>TO</option>
          </select>

          <label>Prospec√ß√£o</label>
          <select name="prospeccao" required>
            <option value="">Selecione</option>
            <option>Leads</option><option>Internet</option><option>Indica√ß√£o</option><option>Liga√ß√£o</option><option>Visita</option><option>J√° √© cliente</option>
          </select>

          <label>Nome</label>
          <input type="text" name="nome" required>

          <label>Fun√ß√£o</label>
          <select name="funcao" required>
            <option value="">Selecione</option>
            <option>Funcion√°rio</option><option>Vendedor</option><option>Propriet√°rio</option><option>Gerente</option><option>Financeiro</option>
          </select>

          <label>Contato</label>
          <input type="tel" name="contato" placeholder="+55 (DDD) 90000-0000" required>

          <label>Reuni√£o</label>
          <select name="reuniao" id="tipoReuniao" required>
            <option value="">Selecione</option>
            <option value="Liga√ß√£o">Liga√ß√£o</option>
            <option value="Whats">Whats</option>
            <option value="Meet">Meet</option>
          </select>

          <div class="row">
            <div>
              <label>Data da Reuni√£o</label>
              <input type="date" name="data_reuniao" required>
            </div>
            <div>
              <label>Hor√°rio</label>
              <input type="time" name="horario" required>
            </div>
          </div>

          <label>Consultor</label>
          <select name="consultor" id="consultorSelect" required>
            <option value="">Selecione</option>
            <option value="5517992741145">Glaucia ‚Äî +55 17 99274-1145</option>
            <option value="5517992021249">Leticia ‚Äî +55 17 99202-1249</option>
            <option value="5517992724400">Marcelo ‚Äî +55 17 99272-4400</option>
            <option value="5517992739551">Gabriel ‚Äî +55 17 99273-9551</option>
          </select>

          <label>Observa√ß√µes</label>
          <textarea name="observacoes" rows="3" placeholder="Observa√ß√µes..."></textarea>

          <div class="actions">
            <button id="btnSalvar" type="button">üíæ Salvar (Planilha)</button>
            <button id="btnWhats" type="button">üì≤ Enviar WhatsApp (Comprovante)</button>
            <button id="btnClear" type="button" class="btn-secondary">Limpar</button>
          </div>
        </form>
      </div>

      <!-- Right: painel simples -->
      <div>
        <div class="card">
          <div><div class="small">Painel</div><strong id="panelTitle">Vis√£o</strong></div>
          <div style="margin-top:12px" id="panelsContent">
            <div class="small">Reuni√µes recentes</div>
            <div id="meetingsList" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </div>

    <div style="height:12px"></div>
    <div class="muted">Obs: substitua <code>YOUR_GOOGLE_API_KEY</code> pela sua API Key no c√≥digo abaixo.</div>
  </div>

  <!-- libs -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>

  <script>
  // CONFIG - insira sua API KEY abaixo
  const GOOGLE_CLIENT_ID = '689575420157-di4d81kgeo6tnaf70edsi6sii5523sev.apps.googleusercontent.com';
  const GOOGLE_API_KEY = 'YOUR_GOOGLE_API_KEY'; // <- coloque sua API key aqui
  const SHEET_ID = '1-kcIEyUDiBWcGEUKxqotqlpyT-hIta5k3Cx1_mFEUIg';
  const SHEET_RANGE = 'Sheet1!A1:Z9999';

  // DOM
  const btnSignIn = document.getElementById('btnSignIn');
  const btnSignOut = document.getElementById('btnSignOut');
  const userEmailEl = document.getElementById('userEmail');
  const btnSalvar = document.getElementById('btnSalvar');
  const btnWhats = document.getElementById('btnWhats');
  const btnClear = document.getElementById('btnClear');
  const meetingsListEl = document.getElementById('meetingsList');

  // state
  let tokenClient;
  let gapiInited = false;
  let userProfile = null;

  // init gapi when loaded
  function initGapiClient(){
    gapi.load('client', async () => {
      try {
        await gapi.client.init({
          apiKey: GOOGLE_API_KEY,
          discoveryDocs: [
            'https://sheets.googleapis.com/$discovery/rest?version=v4',
            'https://www.googleapis.com/discovery/v1/apis/calendar/v3/rest'
          ]
        });
        gapiInited = true;
        console.log('gapi initialized');
        // try load meetings (will succeed only after auth for private data if needed)
        loadMeetings().catch(()=>{/*ignore*/});
      } catch (err) {
        console.error('gapi init error', err);
      }
    });
  }

  // init token client
  function initTokenClient(){
    tokenClient = google.accounts.oauth2.initTokenClient({
      client_id: GOOGLE_CLIENT_ID,
      scope: 'https://www.googleapis.com/auth/spreadsheets https://www.googleapis.com/auth/calendar.events openid email profile',
      callback: (resp) => {
        if (resp.error) {
          console.error('token error', resp);
          alert('Erro ao autenticar: ' + resp.error);
          return;
        }
        // get user info using access token
        fetch('https://www.googleapis.com/oauth2/v3/userinfo', { headers: { Authorization: 'Bearer ' + resp.access_token }})
          .then(r=>r.json()).then(profile => {
            userProfile = profile;
            afterSignIn();
            loadMeetings().catch(()=>{/*ignore*/});
          }).catch(e => console.error(e));
      }
    });
  }

  btnSignIn.addEventListener('click', () => {
    if (!tokenClient) initTokenClient();
    tokenClient.requestAccessToken({prompt:'consent'});
  });
  btnSignOut.addEventListener('click', () => {
    userProfile = null;
    userEmailEl.textContent = 'N√£o conectado';
    btnSignOut.style.display = 'none';
    btnSignIn.style.display = 'inline-block';
  });

  function afterSignIn(){
    if(!userProfile) return;
    userEmailEl.textContent = userProfile.email;
    btnSignOut.style.display = 'inline-block';
    btnSignIn.style.display = 'none';
  }

  // collect form values into object
  function coletarDadosFormulario(){
    const f = document.getElementById('formAgendamento');
    const fd = new FormData(f);
    return {
      data_contato: fd.get('data_contato') || '',
      empresa: fd.get('empresa') || '',
      cnpj: fd.get('cnpj') || '',
      qtd_lojas: fd.get('qtd_lojas') || '',
      segmento: fd.get('segmento') || '',
      uf: fd.get('uf') || '',
      prospeccao: fd.get('prospeccao') || '',
      nome: fd.get('nome') || '',
      funcao: fd.get('funcao') || '',
      contato: fd.get('contato') || '',
      reuniao_tipo: fd.get('reuniao') || '',
      data_reuniao: fd.get('data_reuniao') || '',
      horario: fd.get('horario') || '',
      consultor_number: fd.get('consultor') || '',
      observacoes: fd.get('observacoes') || '',
      agendado_por: userProfile ? userProfile.email : 'anon',
      created_at: new Date().toISOString()
    };
  }

  // append to sheet (requires gapi initialized)
  async function salvarNaPlanilha(d){
    if(!gapiInited) throw new Error('APIs n√£o inicializadas');
    // Map columns ‚Äî aqui definimos a ordem que ser√° inserida na sua planilha
    const row = [
      d.created_at,
      d.data_contato,
      d.empresa,
      d.cnpj,
      d.qtd_lojas,
      d.segmento,
      d.uf,
      d.prospeccao,
      d.nome,
      d.funcao,
      d.contato,
      d.reuniao_tipo,
      d.data_reuniao,
      d.horario,
      consultorNumberToName(d.consultor_number),
      d.consultor_number,
      '', // meet link placeholder
      d.observacoes,
      d.agendado_por
    ];
    const params = { spreadsheetId: SHEET_ID, range: SHEET_RANGE, valueInputOption: 'RAW' };
    const body = { values: [ row ] };
    const resp = await gapi.client.sheets.spreadsheets.values.append(params, body);
    return resp;
  }

  // send whatsapp: opens wa.me link with encoded message
  function enviarWhatsapp(d, meetLink=''){
    const name = consultorNumberToName(d.consultor_number);
    let mensagem = `üìÖ Novo agendamento de reuni√£o\n`;
    mensagem += `üè¢ Empresa: ${d.empresa}\n`;
    mensagem += `üìÖ Data: ${d.data_reuniao} √†s ${d.horario}\n`;
    mensagem += `üë§ Contato: ${d.nome} (${d.funcao})\n`;
    mensagem += `üìû Telefone: ${d.contato}\n`;
    mensagem += `üìå Tipo: ${d.reuniao_tipo}\n`;
    if(meetLink) mensagem += `üîó Meet: ${meetLink}\n`;
    mensagem += `üè∑ Segmento: ${d.segmento} ‚Äî UF: ${d.uf}\n`;
    mensagem += `üìù Obs: ${d.observacoes || '-'}\n\n`;
    mensagem += `Enviado por: ${d.agendado_por}`;

    const numero = d.consultor_number.replace(/\D/g,'');
    const waUrl = `https://wa.me/${numero}?text=${encodeURIComponent(mensagem)}`;
    window.open(waUrl, '_blank');
  }

  // helper map
  function consultorNumberToName(num){
    const map = {
      '5517992741145':'Glaucia',
      '5517992021249':'Leticia',
      '5517992724400':'Marcelo',
      '5517992739551':'Gabriel'
    };
    return map[num] || num;
  }

  // Handlers for the two buttons
  btnSalvar.addEventListener('click', async () => {
    if(!userProfile){ alert('Fa√ßa login com Google antes de salvar.'); return; }
    const dados = coletarDadosFormulario();
    try {
      await salvarNaPlanilha(dados);
      alert('Salvo na planilha com sucesso.');
      loadMeetings().catch(()=>{/*ignore*/});
    } catch (err) {
      console.error(err);
      alert('Erro ao salvar ‚Äî veja console.');
    }
  });

  btnWhats.addEventListener('click', async () => {
    const dados = coletarDadosFormulario();
    // opcional: se quiser garantir que j√° foi salvo antes de enviar, descomente:
    // await salvarNaPlanilha(dados);
    // se quiser criar meet antes de enviar (quando tipo=Meet), poder√≠amos chamar createCalendarEvent...
    enviarWhatsapp(dados, '');
  });

  btnClear.addEventListener('click', () => document.getElementById('formAgendamento').reset());

  // Load meetings (read sheet) to show recent in panel
  async function loadMeetings(){
    if(!gapiInited) return;
    try {
      const res = await gapi.client.sheets.spreadsheets.values.get({ spreadsheetId: SHEET_ID, range: SHEET_RANGE });
      const rows = res.result.values || [];
      if(rows.length < 2){ meetingsListEl.innerHTML = '<div class="muted">Nenhuma reuni√£o registrada</div>'; return; }
      const header = rows[0];
      const data = rows.slice(1).map(r => {
        const obj = {};
        header.forEach((h,i)=> obj[h] = r[i] || '');
        return obj;
      });
      // show 10 most recent
      meetingsListEl.innerHTML = '';
      data.slice(-10).reverse().forEach(row => {
        const d = document.createElement('div');
        d.style.padding = '8px';
        d.style.borderBottom = '1px solid #f1f3f6';
        d.innerHTML = `<strong>${row[2]||row['Empresa']||row['empresa']||''}</strong>
                       <div class="muted">${row[12]||row['data_reuniao']||''} ${row[13]||row['horario']||''} ‚Äî ${row[14]||row['consultor']||''}</div>`;
        meetingsListEl.appendChild(d);
      });
    } catch (err) {
      console.error('loadMeetings error', err);
    }
  }

  // init on load
  window.onload = () => {
    // wait for gapi library to be available
    const waitGapi = setInterval(() => {
      if(window.gapi && window.google){
        clearInterval(waitGapi);
        initGapiClient();
        initTokenClient();
      }
    }, 300);
  };

  </script>
</body>
</html>
